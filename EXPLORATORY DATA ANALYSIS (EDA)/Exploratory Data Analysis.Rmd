---
title: "Análisis exploratorio de datos"
author: "Mauricio Vazquez"
date: '2025-03-14'
output:
  pdf_document:
    latex_engine: xelatex
---

***Link del repositorio de GitHub: https://github.com/MauricioVazquezM/Data_Visualization_Course_Project***

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, fig.width=10)

# Libraries
library(MASS)  
library(ggplot2)
library(GGally)
library(mclust)
library(kableExtra)
library(FactoMineR)
library(knitr)
library(caret)
library(dplyr)
library(gridExtra)
library(corrplot)
library(ggcorrplot)
library(car)
library(lmtest)
library(tidyr)
```

```{r, echo=FALSE}
# Lectura de los datos
data <- read.csv("C:\\Users\\mauva\\OneDrive\\Documents\\ITAM\\10mo Semestre\\VISUALIZACION DE LA INFORMACION\\CODIGO\\PROJECT REPOSITORY\\Data_Visualization_Course_Project\\DATA\\ESGData.csv")
colnames(data) <- colnames(data) %>%
  tolower() %>%                       
  gsub("\\.", "_", .) %>%               
  gsub("^x(\\d{4})$", "\\1", .)   
# head(data)
```

<br>

## Objetivo

* El objetivo principal de este analisis explorartio es comprender y visualizar la estructura de los datos para extraer información relevante. Se busca identificar tendencias y patrones en problemas globales, explorar relaciones entre variables clave, y realizar comparaciones entre distintos países y regiones. Además, el análisis permitirá evaluar el impacto de eventos globales en los datos.

<br>

## Primeras observaciones

***Descripción*** 

El dataset seleccionado proviene del Banco Mundial y contiene datos sobre indicadores ambientales, sociales y de gobernanza (ESG) a nivel país y región. Con una estructura de aproximadamente 16000 filas y un total de 67 columnas, permite analizar la evolución de diversas métricas clave desde 1960 hasta 2020. 

<br>

***Columnas principales***

```{r echo=FALSE, warning=FALSE}
# Descripcion columnas principales
tabla_columnas <- data.frame(
  Variable = c("Country.Name", "Country.Code", "Indicator.Name", "Indicator.Code",
               "X1960 – X2020", "X2050", "X"),
  Descripción = c("Nombre del país o región",
                  "Código de tres letras asignado a cada país",
                  "Nombre del indicador (ej. emisiones de CO₂, acceso a electricidad)",
                  "Código asociado al indicador",
                  "Valores anuales del indicador correspondiente para cada país",
                  "Proyecciones para 2050 (si están disponibles)",
                  "Columna vacía (posiblemente residual de la extracción de datos)")
)

# Tabla descripcion
tabla_columnas %>%
  kable(format = "latex", booktabs = TRUE, caption = "Descripción de las columnas del dataset") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

***Variables categóricas*** 
 
 - `Country.Name`, `Country.Code`, `Indicator.Name`, `Indicator.Code`  
 
 ***Variables cuantitativas***  
 
 - Columnas de años (`X1960` a `X2020` y `X2050`), que contienen valores cuantitativos de cada indicador.  
  
## Análisis exploratorio de datos

***Análisis univariado de los datos***

<br>

```{r echo=FALSE, warning=FALSE}
# Funcion de analisis univariado
univar_analisis <- function(data) {
  results <- list()
  
  for (feature in colnames(data)) {
    data_type <- class(data[[feature]])[1]
    
    total <- nrow(data)
    nan_count <- sum(is.na(data[[feature]]))
    no_missings <- total - nan_count
    pct_missings <- nan_count / total
    
    if (is.numeric(data[[feature]])) {
      promedio <- round(mean(data[[feature]], na.rm = TRUE),2)
      desv_estandar <- round(sd(data[[feature]], na.rm = TRUE),2)
      varianza <- round(var(data[[feature]], na.rm = TRUE),2)
      minimo <- min(data[[feature]], na.rm = TRUE)
      p10 <- quantile(data[[feature]], 0.10, na.rm = TRUE)
      q1 <- quantile(data[[feature]], 0.25, na.rm = TRUE)
      mediana <- quantile(data[[feature]], 0.50, na.rm = TRUE)
      q3 <- quantile(data[[feature]], 0.75, na.rm = TRUE)
      p90 <- quantile(data[[feature]], 0.90, na.rm = TRUE)
      maximo <- max(data[[feature]], na.rm = TRUE)
      
      inf_count <- sum(is.infinite(data[[feature]]) & data[[feature]] > 0)
      neg_inf_count <- sum(is.infinite(data[[feature]]) & data[[feature]] < 0)
    } else {
      promedio <- NA
      desv_estandar <- NA
      varianza <- NA
      minimo <- NA
      p10 <- NA
      q1 <- NA
      mediana <- NA
      q3 <- NA
      p90 <- NA
      maximo <- NA
    }
    
    results[[length(results) + 1]] <- list(
      
      Variable = feature,
      Total = total,
      No_Missings = no_missings,
      Missings = nan_count,
      Pct_Missings = pct_missings,
      Promedio = promedio,
      Desv_Std = desv_estandar,
      Varianza = varianza,
      Minimo = minimo,
      p10 = p10,
      q1 = q1,
      Mediana = mediana,
      q3 = q3,
      p90 = p90,
      Maximo = maximo
    )
  }
  
  result_df <- do.call(rbind, lapply(results, as.data.frame))
  
  rownames(result_df) <- NULL
  
  return(result_df)
  
}

# Seleccionar las columnas para el análisis
cols_to_analyze <- c("country_name", "country_code", "indicator_name", "indicator_code",
                     "1960", "1970", "1980", "1990", "2000", "2010", "2020")

# Filtrar solo las columnas relevantes
data_filtered <- data[, cols_to_analyze, drop = FALSE]

# Aplicar la función de análisis univariado
resultados <- univar_analisis(data_filtered)

# Separar el análisis en dos partes
resultados_parte1 <- resultados[, c("Variable", "Total", "No_Missings", "Missings", "Pct_Missings")]

# resultados_parte2 <- resultados[, c("Minimo", "p10", "q1", "Mediana", "q3", "p90", "Maximo")]

# Mostrar los resultados en dos tablas separadas por margenes de pagina
resultados_parte1 %>%
  kable(caption = "Análisis de valores nulos", booktabs = TRUE) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

- El análisis de valores nulos muestra que las variables categóricas no presentan valores nulos, mientras que las variables numéricas (años) tienen una alta proporción de valores nulos. Especialmente, en los años 1960 (91.55%) y 2020 (97.10%). A medida que avanzan los años, la disponibilidad de datos mejora, con una reducción gradual de valores nulos, destacando que desde el 2000 los datos son estan mas completos. Esto nos indica que muchos indicadores comenzaron a ser medidos en décadas recientes. 

<br>

***Visualización de las variables***

Primero, debemos preguntarnos: ¿cuáles son los indicadores con mayor cantidad de valores nulos y, por lo tanto, no aportan datos útiles para generar _insights_ más adelante?

```{r echo=FALSE, fig.align="center", fig.width=12, fig.height=6,, warning=FALSE}
# Contar los valores nulos por indicador
missing_values <- data %>%
  group_by(indicator_name) %>%
  summarise(Valores_Nulos = sum(is.na(across(where(is.numeric))))) %>%
  arrange(desc(Valores_Nulos)) %>%
  head(15)  

# Generar la visualización
ggplot(missing_values, aes(x = reorder(indicator_name, Valores_Nulos), y = Valores_Nulos, fill = Valores_Nulos)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +  
  theme_minimal(base_size = 14) +
  labs(
    title = "Top 15 indicadores con mas valores nulos",
    subtitle = "Número total de valores nulos",
    x = "Indicador",
    y = "Cantidad de valores nulos",
    caption = "Fuente: Base de datos ESG"
  ) +
  theme(
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )
```


Con el fin de ilustrar un indicador, comenzaremos explorando el indicador _Access to electricity (% of population)_. Para el cual tenemos la siguiente visualizacion: 

```{r echo=FALSE, fig.align="center", warning=FALSE}
# Paises sleccionados aleatoriamente
selected_countries <- c("Iceland", "Japan", "Haiti", "Germany", "Ethiopia", 
                        "Cuba", "Kuwait", "New Zealand", "Norway", "Panama")

# Filtrar los paises en la data
data_long <- data %>%
  filter(indicator_name == "Access to electricity (% of population)",
         country_name %in% selected_countries) %>%
  pivot_longer(cols = c("1980", "1985", "1990", "1995", "2000", "2005", "2010", "2015", "2020"), 
               names_to = "Año", values_to = "Valor") %>%
  mutate(Año = as.numeric(Año))

# Gráfico de evolución del acceso a la electricidad
ggplot(data_long, aes(x = Año, y = Valor, group = country_name, color = country_name)) +
  geom_line(size = 1) +  
  geom_point(size = 2) + 
  theme_minimal(base_size = 14) +  
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  labs(
    title = "Tendencia del Acceso a Electricidad (% de población)",
    subtitle = "Evolución en los 10 países con mayor acceso al 2020",
    x = "Año",
    y = "Pct de población con acceso",
    color = "País",  
    caption = "Fuente: Base de datos ESG"
  ) +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 10), 
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank() 
  )
```


